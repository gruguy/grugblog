name: Deploy to Remote Server

on:
  push:
    branches: [main] # 监听main分支的推送

  workflow_dispatch: # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 构建前端镜像
      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          tags: blog-frontend:latest
          outputs: type=docker,dest=/tmp/blog-frontend.tar

      # 4. 构建后端镜像
      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          tags: blog-backend:latest
          outputs: type=docker,dest=/tmp/blog-backend.tar

      # 5. 构建管理端镜像
      - name: Build admin image
        uses: docker/build-push-action@v5
        with:
          context: ./admin
          tags: blog-admin:latest
          outputs: type=docker,dest=/tmp/blog-admin.tar

      # 6. 上传前端镜像到远程服务器
      - name: Upload frontend image to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_SERVER_HOST }}
          username: ${{ secrets.REMOTE_SERVER_USERNAME }}
          password: ${{ secrets.REMOTE_SERVER_PASSWORD }}
          port: ${{ secrets.REMOTE_SERVER_PORT || '22' }}
          source: /tmp/blog-frontend.tar
          target: /tmp

      # 7. 上传后端镜像到远程服务器
      - name: Upload backend image to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_SERVER_HOST }}
          username: ${{ secrets.REMOTE_SERVER_USERNAME }}
          password: ${{ secrets.REMOTE_SERVER_PASSWORD }}
          port: ${{ secrets.REMOTE_SERVER_PORT || '22' }}
          source: /tmp/blog-backend.tar
          target: /tmp

      # 8. 上传管理端镜像到远程服务器
      - name: Upload admin image to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_SERVER_HOST }}
          username: ${{ secrets.REMOTE_SERVER_USERNAME }}
          password: ${{ secrets.REMOTE_SERVER_PASSWORD }}
          port: ${{ secrets.REMOTE_SERVER_PORT || '22' }}
          source: /tmp/blog-admin.tar
          target: /tmp

      # 9. 上传docker-compose.yml到远程服务器
      - name: Upload docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_SERVER_HOST }}
          username: ${{ secrets.REMOTE_SERVER_USERNAME }}
          password: ${{ secrets.REMOTE_SERVER_PASSWORD }}
          port: ${{ secrets.REMOTE_SERVER_PORT || '22' }}
          source: docker-compose.yml
          target: /var/www/gruguy-blog

      # 10. 在远程服务器上部署
      - name: Deploy on remote server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_SERVER_HOST }}
          username: ${{ secrets.REMOTE_SERVER_USERNAME }}
          password: ${{ secrets.REMOTE_SERVER_PASSWORD }}
          port: ${{ secrets.REMOTE_SERVER_PORT || '22' }}
          script: |
            # 进入项目目录
            cd /var/www/gruguy-blog

            # 加载镜像
            docker load -i /tmp/blog-frontend.tar
            docker load -i /tmp/blog-backend.tar
            docker load -i /tmp/blog-admin.tar

            # 启动容器
            docker-compose up -d

            # 清理临时文件和无用镜像
            rm /tmp/blog-*.tar
            docker image prune -f
