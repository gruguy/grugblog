name: Deploy to Remote Server

on:
  push:
    branches: [main] # 监听main分支的推送

  workflow_dispatch: # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 连接到远程服务器并部署
      - name: Deploy to remote server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_SERVER_HOST }}
          username: ${{ secrets.REMOTE_SERVER_USERNAME }}
          password: ${{ secrets.REMOTE_SERVER_PASSWORD }}
          port: ${{ secrets.REMOTE_SERVER_PORT || '22' }}
          script: |
            # 进入项目目录
            cd /var/www/gruguy-blog  # 替换为你的项目路径

            # 拉取最新代码
            git pull origin main

            # 直接在服务器上构建镜像并启动容器
            docker-compose up -d --build

            # 清理未使用的镜像
            docker image prune -f
