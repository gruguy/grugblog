import{e as ee,r as u,x as z,h as te,L as oe,c as g,o as p,a as e,M as O,N as se,t as P,_ as re,Z as le,V as ie,n as W,b as C,J as D,w as M,d as S,H as I,I as Z,F as de,G as c,Y as ue,X as K,P as T,Q as $}from"./CgBFakhS.js";import{u as ce,r as me}from"./D6gG8p-B.js";import{u as pe}from"./Cp8QfXaB.js";import{M as G}from"./awhFlHqN.js";import{m as R}from"./CMFYFJiA.js";const ve={class:"drag-captcha"},fe={class:"captcha-container"},ge={class:"captcha-body"},be={class:"puzzle-area"},he={class:"puzzle-bg-container"},we={class:"drag-track"},ye={class:"track-bar"},xe=ee({__name:"DragCaptcha",emits:["success","error"],setup(ae,{expose:L,emit:q}){const v=q,i=u(null),V=u(null),x=u(null),d=u(null),n={width:300,height:150,pieceSize:40,tolerance:5},w=u(!1),E=u(0),f=u(0),b=u(0),h=u("idle"),_=u("请拖动滑块完成拼图"),B=u(""),j=z(()=>({left:`${b.value}px`,transform:w.value?"scale(1.1)":"scale(1)",transition:w.value?"transform 0.2s ease":"all 0.3s ease"})),A=z(()=>({left:`${f.value}px`})),F=z(()=>({width:`${b.value/(n.width-n.pieceSize)*100}%`})),X=z(()=>h.value==="success"?"success":h.value==="error"?"error":""),U=()=>{if(!i.value||!V.value)return;const o=i.value.getContext("2d"),s=V.value.getContext("2d");if(!o||!s)return;i.value.width=n.width,i.value.height=n.height,V.value.width=n.pieceSize,V.value.height=n.pieceSize,f.value=Math.floor(Math.random()*(n.width-n.pieceSize*2))+n.pieceSize;const l=o.createLinearGradient(0,0,n.width,n.height),a=`#${Math.floor(Math.random()*16777215).toString(16).padStart(6,"0")}`,N=`#${Math.floor(Math.random()*16777215).toString(16).padStart(6,"0")}`;l.addColorStop(0,a),l.addColorStop(1,N),o.fillStyle=l,o.fillRect(0,0,n.width,n.height);for(let Y=0;Y<50;Y++){o.beginPath();const J=Math.random()*n.width,Q=Math.random()*n.height,H=Math.random()*15+5;o.fillStyle=`rgba(255, 255, 255, ${Math.random()*.5+.2})`,Math.random()>.5?o.arc(J,Q,H,0,Math.PI*2):o.fillRect(J,Q,H,H),o.fill()}m(s,0,0,n.pieceSize),s.globalCompositeOperation="source-in",s.drawImage(i.value,f.value,(n.height-n.pieceSize)/2,n.pieceSize,n.pieceSize,0,0,n.pieceSize,n.pieceSize)},m=(o,s,l,a)=>{o.beginPath(),o.moveTo(s+a*.25,l),o.lineTo(s+a*.75,l),o.bezierCurveTo(s+a*.75,l-a*.15,s+a,l-a*.15,s+a,l+a*.25),o.lineTo(s+a,l+a*.75),o.bezierCurveTo(s+a,l+a*.9,s+a*.75,l+a*.9,s+a*.75,l+a),o.lineTo(s+a*.25,l+a),o.bezierCurveTo(s+a*.25,l+a*.9,s,l+a*.9,s,l+a*.75),o.lineTo(s,l+a*.25),o.bezierCurveTo(s,l-a*.15,s+a*.25,l-a*.15,s+a*.25,l),o.closePath(),o.fillStyle="#fff",o.fill(),o.strokeStyle="#ccc",o.lineWidth=1,o.stroke()},t=o=>{if(h.value!=="idle")return;w.value=!0,h.value="dragging",_.value="拖动滑块完成拼图";const s=o instanceof MouseEvent?o.clientX:o.touches[0].clientX,l=d.value?.getBoundingClientRect();l&&(E.value=s-l.left),document.addEventListener("mousemove",y),document.addEventListener("mouseup",k),document.addEventListener("touchmove",y),document.addEventListener("touchend",k)},y=o=>{if(!w.value)return;const s=o instanceof MouseEvent?o.clientX:o.touches[0].clientX,l=d.value?.parentElement?.getBoundingClientRect();if(!l)return;let a=s-l.left-E.value;const N=n.width-n.pieceSize;a=Math.max(0,Math.min(a,N)),b.value=a},k=()=>{if(!w.value)return;w.value=!1,Math.abs(b.value-f.value)<=n.tolerance?(h.value="success",_.value="验证成功",B.value=r(),v("success",B.value)):(h.value="error",_.value="验证失败，请重试",setTimeout(()=>{b.value=0,h.value="idle",_.value="请拖动滑块完成拼图"},800),v("error")),document.removeEventListener("mousemove",y),document.removeEventListener("mouseup",k),document.removeEventListener("touchmove",y),document.removeEventListener("touchend",k)},r=()=>{const o=new Uint8Array(16);return crypto.getRandomValues(o),Array.from(o,s=>s.toString(16).padStart(2,"0")).join("")};return L({refresh:()=>{b.value=0,h.value="idle",_.value="请拖动滑块完成拼图",U()}}),te(()=>{U()}),oe(()=>{document.removeEventListener("mousemove",y),document.removeEventListener("mouseup",k),document.removeEventListener("touchmove",y),document.removeEventListener("touchend",k)}),(o,s)=>(p(),g("div",ve,[e("div",fe,[s[2]||(s[2]=e("div",{class:"captcha-title"},"拖动滑块完成拼图验证",-1)),e("div",ge,[e("div",be,[e("div",he,[e("canvas",{ref_key:"bgCanvas",ref:i,class:"puzzle-bg"},null,512),e("div",{class:"puzzle-mask",style:O(A.value)},null,4)]),e("div",{ref_key:"puzzlePiece",ref:x,class:"puzzle-piece",style:O(j.value),onMousedown:t,onTouchstart:t},[e("canvas",{ref_key:"pieceCanvas",ref:V,class:"piece-canvas"},null,512),s[0]||(s[0]=e("div",{class:"piece-border"},null,-1))],36)]),e("div",we,[e("div",ye,[e("div",{class:"track-fill",style:O(F.value)},null,4)]),e("div",{ref_key:"dragHandle",ref:d,class:"drag-handle",onMousedown:t,onTouchstart:t},[...s[1]||(s[1]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[e("polyline",{points:"9 18 15 12 9 6","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],544)]),e("div",{class:se(["status-text",X.value])},P(_.value),3)])])]))}}),_e=Object.assign(re(xe,[["__scopeId","data-v-79cf5e5e"]]),{__name:"DragCaptcha"}),ke={class:"min-h-screen bg-background flex flex-col"},Ce={class:"sticky top-0 z-50 bg-card border-b border-border"},Me={class:"container mx-auto px-4"},Se={class:"flex items-center justify-between h-16"},Le={class:"hidden md:flex items-center space-x-6"},Ve={class:"hidden md:flex items-center space-x-4"},Pe={class:"flex items-center space-x-2"},Ee={class:"relative group"},Te={class:"flex items-center gap-2"},$e={key:0,class:"w-8 h-8 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white font-medium text-xs border border-border"},Re=["src"],Ue={class:"text-sm font-medium hidden md:inline"},ze={class:"absolute right-0 mt-2 w-48 bg-card border border-border rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50"},Be={class:"py-2"},je={key:0,class:"md:hidden border-t border-border bg-card"},De={class:"container mx-auto px-4 py-4 space-y-2"},Ie={class:"container mx-auto px-4 py-8"},qe={class:"border-t border-border bg-card mt-auto"},Ae={class:"container mx-auto px-4 py-8"},Fe={class:"text-center text-muted-foreground"},Xe={class:"p-0"},Ne={class:"mb-4 px-6 pt-6"},He={class:"mb-4 px-6"},Oe={class:"mb-6 px-6"},Ge=["disabled"],Ye={key:0},Je={key:1},Qe={class:"px-6 pb-6 text-center"},We={class:"text-sm text-muted-foreground"},Ze={class:"p-0"},Ke={class:"mb-4 px-6 pt-6"},et={class:"mb-4 px-6"},tt={class:"mb-4 px-6"},ot={class:"mb-6 px-6"},st={key:0,class:"mb-4 px-6 text-red-500 text-sm"},rt={class:"mb-6 px-6"},at=["disabled"],nt={key:0,viewBox:"0 0 24 24",fill:"currentColor",class:"w-5 h-5"},lt={class:"p-2"},it={class:"mb-6 px-6"},dt=["disabled"],ut={key:0},ct={key:1},mt={class:"px-6 pb-6 text-center"},pt={class:"text-sm text-muted-foreground"},vt=ee({__name:"default",setup(ae){const L=u(!1),q=z(()=>new Date().getFullYear()),v=ce(),i=pe(),V=le();ie(()=>V.query.modal,m=>{m==="login"?i.openLoginModal():m==="register"&&i.openRegisterModal()},{immediate:!0});const x=u({username:"",password:""}),d=u({username:"",email:"",password:"",confirmPassword:""}),n=u(!1),w=u(!1),E=u(null),f=u(!1),b=u(""),h=u(!1),_=m=>{f.value=!0,b.value=m,h.value=!1,R.success("人机验证成功")},B=()=>{f.value=!1,b.value=""},j=[{name:"首页",path:"/"},{name:"文章",path:"/articles"},{name:"音乐",path:"/music"},{name:"相册",path:"/gallery"},{name:"Vlog",path:"/vlog"},{name:"关于",path:"/about"}],A=()=>{L.value=!L.value},F=async()=>{n.value=!0;try{await v.userLogin(x.value.username,x.value.password),i.showLoginModal=!1,x.value={username:"",password:""},R.success("登录成功")}catch(m){console.error("登录失败:",m),R.error(m.response?.data?.message||"登录失败，请检查用户名和密码")}finally{n.value=!1}},X=async()=>{if(d.value.password===d.value.confirmPassword){if(!f.value||!b.value){R.error("请先完成人机验证");return}w.value=!0;try{await me({...d.value,captchaToken:b.value}),i.showRegisterModal=!1,d.value={username:"",email:"",password:"",confirmPassword:""},E.value?.reset(),f.value=!1,b.value="",R.success("注册成功，请登录"),setTimeout(()=>{i.openLoginModal()},1e3)}catch(m){console.error("注册失败:",m),E.value?.reset(),f.value=!1,b.value="",R.error(m.response?.data?.message||"注册失败，请检查输入信息")}finally{w.value=!1}}},U=m=>{m.target.closest("nav")||(L.value=!1)};return te(()=>{document.addEventListener("click",U),v.token&&v.fetchUserInfo()}),oe(()=>{document.removeEventListener("click",U)}),(m,t)=>{const y=W("RouterLink"),k=W("router-link");return p(),g("div",ke,[e("nav",Ce,[e("div",Me,[e("div",Se,[C(y,{to:"/",class:"text-2xl font-bold text-primary"},{default:M(()=>[...t[16]||(t[16]=[S("个人博客",-1)])]),_:1}),e("div",Le,[(p(),g(I,null,Z(j,r=>C(y,{key:r.path,to:r.path,class:"text-foreground hover:text-primary transition-colors","active-class":"text-primary font-medium"},{default:M(()=>[S(P(r.name),1)]),_:2},1032,["to"])),64))]),e("div",Ve,[c(v).isLoggedIn?(p(),de(k,{key:0,to:"/editor",class:"px-6 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors"},{default:M(()=>[...t[17]||(t[17]=[S(" 马上发表 ",-1)])]),_:1})):D("",!0),e("div",Pe,[c(v).isLoggedIn?(p(),g(I,{key:1},[t[20]||(t[20]=e("button",{class:"p-2 rounded-full hover:bg-muted transition-colors relative",title:"消息"},[e("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"})]),e("span",{class:"absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"})],-1)),e("div",Ee,[e("button",Te,[c(v).user?.avatar?(p(),g("img",{key:1,src:c(v).user?.avatar,alt:"头像",class:"w-8 h-8 rounded-full object-cover border border-border"},null,8,Re)):(p(),g("div",$e,P((c(v).user?.username||"U").charAt(0).toUpperCase()),1)),e("span",Ue,P(c(v).user?.nickname||c(v).user?.username||""),1)]),e("div",ze,[e("div",Be,[C(y,{to:"/profile",class:"block px-4 py-2 text-sm text-foreground hover:bg-muted transition-colors"},{default:M(()=>[...t[19]||(t[19]=[S("个人中心",-1)])]),_:1}),e("button",{onClick:t[2]||(t[2]=(...r)=>c(v).userLogout&&c(v).userLogout(...r)),class:"block w-full text-left px-4 py-2 text-sm text-foreground hover:bg-muted transition-colors"}," 退出登录 ")])])])],64)):(p(),g(I,{key:0},[e("button",{onClick:t[0]||(t[0]=r=>c(i).openLoginModal()),class:"text-foreground hover:text-primary transition-colors"}," 登录 "),t[18]||(t[18]=e("span",{class:"text-muted-foreground"},"|",-1)),e("button",{onClick:t[1]||(t[1]=r=>c(i).openRegisterModal()),class:"text-primary hover:underline"}," 注册 ")],64))])]),e("div",{class:"flex items-center"},[e("button",{onClick:A,class:"md:hidden p-2 rounded-md hover:bg-muted transition-colors","aria-label":"菜单"},[...t[21]||(t[21]=[e("svg",{class:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 6h16M4 12h16M4 18h16"})],-1)])])])])]),L.value?(p(),g("div",je,[e("div",De,[(p(),g(I,null,Z(j,r=>C(y,{key:r.path,to:r.path,onClick:t[3]||(t[3]=ne=>L.value=!1),class:"block py-2 text-foreground hover:text-primary transition-colors","active-class":"text-primary font-medium"},{default:M(()=>[S(P(r.name),1)]),_:2},1032,["to"])),64))])])):D("",!0)]),e("main",Ie,[ue(m.$slots,"default",{},void 0,!0)]),e("footer",qe,[e("div",Ae,[e("div",Fe,[e("p",null,"© "+P(q.value)+" 个人博客. All rights reserved.",1)])])]),C(G,{modelValue:c(i).showLoginModal,"onUpdate:modelValue":t[7]||(t[7]=r=>c(i).showLoginModal=r),title:"用户登录"},{default:M(()=>[e("div",Xe,[e("form",{onSubmit:K(F,["prevent"])},[e("div",Ne,[t[22]||(t[22]=e("label",{for:"username",class:"block text-sm font-medium mb-1"},"用户名",-1)),T(e("input",{type:"text",id:"username","onUpdate:modelValue":t[4]||(t[4]=r=>x.value.username=r),class:"w-full px-4 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"请输入用户名",required:"",autofocus:""},null,512),[[$,x.value.username]])]),e("div",He,[t[23]||(t[23]=e("label",{for:"password",class:"block text-sm font-medium mb-1"},"密码",-1)),T(e("input",{type:"password",id:"password","onUpdate:modelValue":t[5]||(t[5]=r=>x.value.password=r),class:"w-full px-4 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"请输入密码",required:""},null,512),[[$,x.value.password]])]),e("div",Oe,[e("button",{type:"submit",class:"w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-primary/90 transition-colors",disabled:n.value},[n.value?(p(),g("span",Ye,"登录中...")):(p(),g("span",Je,"登录"))],8,Ge)]),e("div",Qe,[e("p",We,[t[24]||(t[24]=S(" 还没有账号？ ",-1)),e("button",{type:"button",onClick:t[6]||(t[6]=r=>c(i).toggleModal("register")),class:"text-primary hover:underline"}," 立即注册 ")])])],32)])]),_:1},8,["modelValue"]),C(G,{modelValue:c(i).showRegisterModal,"onUpdate:modelValue":t[15]||(t[15]=r=>c(i).showRegisterModal=r),title:"用户注册"},{default:M(()=>[e("div",Ze,[e("form",{onSubmit:K(X,["prevent"])},[e("div",Ke,[t[25]||(t[25]=e("label",{for:"regUsername",class:"block text-sm font-medium mb-1"},"用户名",-1)),T(e("input",{type:"text",id:"regUsername","onUpdate:modelValue":t[8]||(t[8]=r=>d.value.username=r),class:"w-full px-4 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"请输入用户名",required:"",autofocus:""},null,512),[[$,d.value.username]])]),e("div",et,[t[26]||(t[26]=e("label",{for:"regEmail",class:"block text-sm font-medium mb-1"},"邮箱",-1)),T(e("input",{type:"email",id:"regEmail","onUpdate:modelValue":t[9]||(t[9]=r=>d.value.email=r),class:"w-full px-4 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"请输入邮箱",required:""},null,512),[[$,d.value.email]])]),e("div",tt,[t[27]||(t[27]=e("label",{for:"regPassword",class:"block text-sm font-medium mb-1"},"密码",-1)),T(e("input",{type:"password",id:"regPassword","onUpdate:modelValue":t[10]||(t[10]=r=>d.value.password=r),class:"w-full px-4 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"请输入密码",required:"",minlength:"6"},null,512),[[$,d.value.password]])]),e("div",ot,[t[28]||(t[28]=e("label",{for:"regConfirmPassword",class:"block text-sm font-medium mb-1"},"确认密码",-1)),T(e("input",{type:"password",id:"regConfirmPassword","onUpdate:modelValue":t[11]||(t[11]=r=>d.value.confirmPassword=r),class:"w-full px-4 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"请再次输入密码",required:"",minlength:"6"},null,512),[[$,d.value.confirmPassword]])]),d.value.password!==d.value.confirmPassword?(p(),g("div",st," 两次输入的密码不一致 ")):D("",!0),e("div",rt,[e("button",{type:"button",class:se(["w-full py-3 px-4 rounded-md transition-colors flex items-center justify-center gap-2 text-white font-medium",f.value?"bg-green-500 hover:bg-green-600":"bg-blue-500 hover:bg-blue-600"]),onClick:t[12]||(t[12]=r=>h.value=!0),disabled:f.value},[f.value?(p(),g("svg",nt,[...t[29]||(t[29]=[e("path",{d:"M20 6L9 17L4 12","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])])):D("",!0),S(" "+P(f.value?"验证已完成":"点击完成人机验证"),1)],10,at)]),C(G,{modelValue:h.value,"onUpdate:modelValue":t[13]||(t[13]=r=>h.value=r),title:"人机验证",width:"400px"},{default:M(()=>[e("div",lt,[C(_e,{ref_key:"captchaRef",ref:E,onSuccess:_,onError:B},null,512)])]),_:1},8,["modelValue"]),e("div",it,[e("button",{type:"submit",class:"w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-primary/90 transition-colors",disabled:w.value||d.value.password!==d.value.confirmPassword||!f.value},[w.value?(p(),g("span",ut,"注册中...")):(p(),g("span",ct,"注册"))],8,dt)]),e("div",mt,[e("p",pt,[t[30]||(t[30]=S(" 已有账号？ ",-1)),e("button",{type:"button",onClick:t[14]||(t[14]=r=>c(i).toggleModal("login")),class:"text-primary hover:underline"}," 立即登录 ")])])],32)])]),_:1},8,["modelValue"])])}}}),yt=re(vt,[["__scopeId","data-v-a727d334"]]);export{yt as default};
