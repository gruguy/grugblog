import{e as W,r,h as $,O as z,L as F,c as i,a,K as G,P as M,Q as K,R as Q,H as X,I as Y,G as T,t as h,S as Z,o as d,_ as tt}from"./CgBFakhS.js";import{u as et}from"./D6gG8p-B.js";import{saveArticleDraft as at,publishArticle as ot,getCategories as nt}from"./C4XRcB4j.js";import{m as c,c as U}from"./CMFYFJiA.js";import{m as st,c as x,f as _}from"./ctUnOI-c.js";import"./awhFlHqN.js";import"./CqkleIqs.js";const lt=globalThis.setInterval,rt={class:"editor-container"},it={class:"editor-header"},dt={class:"title-container"},ct=["disabled"],ut={key:0},vt={key:1},ft={class:"category-selector"},pt=["value"],ht={class:"header-actions"},wt=["disabled"],bt={key:0},yt={key:1},gt=["disabled"],kt={key:0},mt={key:1},xt={class:"user-avatar"},_t=["src"],St={key:1,class:"avatar-placeholder"},Ct={class:"editor-preview"},It=["innerHTML"],Mt={class:"editor-footer"},Tt={class:"stats"},At={class:"footer-actions"},Bt={class:"sync-scroll"},jt=W({__name:"Editor",setup(Lt){const w=et(),A=z(),s=r(""),n=r(""),B=r(""),l=r(null),u=r(null),j=r([]),b=r(void 0),S=r(!0),f=r({characters:0,lines:1,words:0}),y=r(!1),g=r(!1),k=r(!1),H=()=>{l.value&&(n.value=l.value.innerText,C(),I())},C=async()=>{B.value=n.value?await st.parse(n.value):""},I=()=>{if(!l.value)return;const o=l.value.textContent||"";f.value.characters=o.length,f.value.lines=(o.match(/\n/g)||[]).length+1,f.value.words=o.trim()?o.trim().split(/\s+/).length:0},L=o=>{if(!S.value||!u.value)return;const t=o.target,e=t.classList.contains("editor-input")?u.value.querySelector(".editor-preview"):u.value.querySelector(".editor-input");e&&(e.scrollTop=t.scrollTop,e.scrollLeft=t.scrollLeft)},D=()=>{l.value&&(l.value.scrollTop=0),u.value?.querySelector(".editor-preview")&&(u.value.querySelector(".editor-preview").scrollTop=0)},E=async()=>{if(!s.value.trim()&&!n.value.trim()){c.warning("请输入标题或内容后再保存草稿");return}const o=x(s.value),t=x(n.value);let e=s.value,p=n.value;if(!((o||t)&&(e=_(s.value),p=_(n.value),!U("您的文章中可能包含敏感词，已自动过滤。是否继续保存？")))){g.value=!0;try{await at({title:e.trim()||"未命名草稿",content:p,status:"draft",categoryId:b.value}),c.success("草稿已保存")}catch(v){console.error("保存草稿失败:",v),c.error(v.response?.data?.message||"保存草稿失败")}finally{g.value=!1}}},P=async()=>{if(!s.value.trim()){c.warning("请先输入文章标题");return}k.value=!0;try{const o="http://61.171.115.123:11434/api/generate";n.value="",l.value&&(l.value.innerHTML="",C(),I());const t=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"deepseek-r1:32b",prompt:`请帮我写一篇关于"${s.value}"的博客文章，内容要丰富，结构清晰，语言流畅。`,stream:!0})});if(!t.ok)throw new Error(`AI接口请求失败: ${t.status}`);if(!t.body)throw new Error("服务器不支持流式响应");const e=new TextDecoder("utf-8"),p=t.body.getReader();let v="";for(;;){const{done:O,value:J}=await p.read();if(O)break;const R=e.decode(J,{stream:!0}).split(`
`);for(const q of R)if(q.trim())try{const m=JSON.parse(q.replace(/^data: /,""));m.response&&(v+=m.response,n.value=v,l.value&&(l.value.innerText=v,C(),I()))}catch(m){console.error("解析JSON数据失败:",m)}}c.success("AI生成内容成功")}catch(o){console.error("AI生成内容失败:",o),c.error("AI生成内容失败，请重试")}finally{k.value=!1}},V=async()=>{if(!s.value.trim()){c.warning("请输入文章标题");return}if(!n.value.trim()){c.warning("请输入文章内容");return}const o=x(s.value),t=x(n.value);if(o||t){const e=_(s.value),p=_(n.value);if(!U("您的文章中可能包含敏感词，已自动过滤。是否继续发布？"))return;n.value=p,s.value=e}y.value=!0;try{const e=await ot({title:s.value.trim(),content:n.value,status:"published",categoryId:b.value});c.success("文章已发表"),A.push(`/article/${e.id}`)}catch(e){console.error("发表文章失败:",e),c.error(e.response?.data?.message||"发表文章失败")}finally{y.value=!1}},N=async()=>{try{const o=await nt();j.value=o}catch(o){console.error("获取分类列表失败:",o),c.error("获取分类列表失败")}};return $(async()=>{if(!w.isLoggedIn){A.push("/");return}if(await N(),l.value&&l.value.focus(),u.value){const t=u.value.querySelector(".editor-input"),e=u.value.querySelector(".editor-preview");t&&t.addEventListener("scroll",L),e&&e.addEventListener("scroll",L)}const o=lt(()=>{(n.value||s.value)&&console.log("自动保存草稿:",{title:s.value,content:n.value})},3e4);F(()=>{clearInterval(o)})}),(o,t)=>(d(),i("div",rt,[a("div",it,[a("div",dt,[M(a("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=e=>s.value=e),placeholder:"输入文章标题...",class:"title-input"},null,512),[[K,s.value]]),a("button",{class:"ai-write-btn",onClick:P,disabled:k.value,title:"AI帮我写"},[k.value?(d(),i("span",ut,"生成中...")):(d(),i("span",vt,"AI帮我写"))],8,ct)]),a("div",ft,[M(a("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>b.value=e),class:"category-dropdown",placeholder:"选择文章分类..."},[t[3]||(t[3]=a("option",{value:""},"未分类",-1)),(d(!0),i(X,null,Y(j.value,e=>(d(),i("option",{key:e.id,value:e.id},h(e.name),9,pt))),128))],512),[[Q,b.value]])]),a("div",ht,[t[4]||(t[4]=a("span",{class:"auto-save"},"文章将自动保存到草稿箱",-1)),a("button",{class:"draft-btn",onClick:E,disabled:g.value},[g.value?(d(),i("span",bt,"保存中...")):(d(),i("span",yt,"保存草稿"))],8,wt),a("button",{class:"publish-btn",onClick:V,disabled:y.value},[y.value?(d(),i("span",kt,"发表中...")):(d(),i("span",mt,"发布"))],8,gt),a("div",xt,[T(w).user?.avatar?(d(),i("img",{key:0,src:T(w).user?.avatar,alt:"头像"},null,8,_t)):(d(),i("div",St,h((T(w).user?.username||"U").charAt(0).toUpperCase()),1))])])]),t[6]||(t[6]=G('<div class="editor-toolbar" data-v-e24f3c5d><button class="toolbar-btn" title="加粗" data-v-e24f3c5d><b data-v-e24f3c5d>B</b></button><button class="toolbar-btn" title="斜体" data-v-e24f3c5d><i data-v-e24f3c5d>I</i></button><button class="toolbar-btn" title="下划线" data-v-e24f3c5d><u data-v-e24f3c5d>U</u></button><button class="toolbar-btn" title="删除线" data-v-e24f3c5d><s data-v-e24f3c5d>S</s></button><button class="toolbar-btn" title="引用" data-v-e24f3c5d><q data-v-e24f3c5d>&quot;</q></button><button class="toolbar-btn" title="图片" data-v-e24f3c5d><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-e24f3c5d><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-e24f3c5d></rect><circle cx="8.5" cy="8.5" r="1.5" data-v-e24f3c5d></circle><polyline points="21 15 16 10 5 21" data-v-e24f3c5d></polyline></svg></button><button class="toolbar-btn" title="链接" data-v-e24f3c5d><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-e24f3c5d><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" data-v-e24f3c5d></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" data-v-e24f3c5d></path></svg></button><button class="toolbar-btn" title="列表" data-v-e24f3c5d><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-e24f3c5d><line x1="8" y1="6" x2="21" y2="6" data-v-e24f3c5d></line><line x1="8" y1="12" x2="21" y2="12" data-v-e24f3c5d></line><line x1="8" y1="18" x2="21" y2="18" data-v-e24f3c5d></line><line x1="3" y1="6" x2="3.01" y2="6" data-v-e24f3c5d></line><line x1="3" y1="12" x2="3.01" y2="12" data-v-e24f3c5d></line><line x1="3" y1="18" x2="3.01" y2="18" data-v-e24f3c5d></line></svg></button><button class="toolbar-btn" title="有序列表" data-v-e24f3c5d><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-e24f3c5d><line x1="10" y1="6" x2="21" y2="6" data-v-e24f3c5d></line><line x1="10" y1="12" x2="21" y2="12" data-v-e24f3c5d></line><line x1="10" y1="18" x2="21" y2="18" data-v-e24f3c5d></line><path d="M4 6h1v4" data-v-e24f3c5d></path><path d="M4 10h2" data-v-e24f3c5d></path><path d="M6 16h1v2" data-v-e24f3c5d></path><path d="M4 16h2" data-v-e24f3c5d></path><path d="M4 12h2" data-v-e24f3c5d></path></svg></button><button class="toolbar-btn" title="代码块" data-v-e24f3c5d><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-e24f3c5d><polyline points="16 18 22 12 16 6" data-v-e24f3c5d></polyline><polyline points="8 6 2 12 8 18" data-v-e24f3c5d></polyline></svg></button><button class="toolbar-btn" title="表格" data-v-e24f3c5d><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-e24f3c5d><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-e24f3c5d></rect><line x1="3" y1="9" x2="21" y2="9" data-v-e24f3c5d></line><line x1="9" y1="3" x2="9" y2="21" data-v-e24f3c5d></line></svg></button><button class="toolbar-btn" title="水平线" data-v-e24f3c5d><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-e24f3c5d><line x1="4" y1="12" x2="20" y2="12" data-v-e24f3c5d></line></svg></button><button class="toolbar-btn" title="撤销" data-v-e24f3c5d><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-e24f3c5d><polyline points="1 4 1 10 7 10" data-v-e24f3c5d></polyline><path d="M10.59 14.59A2 2 0 1 1 14 11h-2a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2a2 2 0 0 0-1.41 0.59l-3 3z" data-v-e24f3c5d></path></svg></button><button class="toolbar-btn" title="重做" data-v-e24f3c5d><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-e24f3c5d><polyline points="23 4 23 10 17 10" data-v-e24f3c5d></polyline><path d="M9.59 14.59A2 2 0 1 0 13 11h2a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-5a2 2 0 0 1-2-2v-2a2 2 0 0 0 0-4h2a2 2 0 0 1 1.41 0.59l3 3z" data-v-e24f3c5d></path></svg></button></div>',1)),a("div",{class:"editor-main",ref_key:"editorMain",ref:u},[a("div",{class:"editor-input",ref_key:"editorInput",ref:l,contenteditable:"true",onInput:H},null,544),a("div",Ct,[a("div",{innerHTML:B.value},null,8,It)])],512),a("div",Mt,[a("div",Tt,[a("span",null,"字符数: "+h(f.value.characters),1),a("span",null,"行数: "+h(f.value.lines),1),a("span",null,"正文字数: "+h(f.value.words),1)]),a("div",At,[a("label",Bt,[M(a("input",{type:"checkbox","onUpdate:modelValue":t[2]||(t[2]=e=>S.value=e)},null,512),[[Z,S.value]]),t[5]||(t[5]=a("span",null,"同步滚动",-1))]),a("button",{class:"back-top",onClick:D},"回到顶部")])])]))}}),Ot=tt(jt,[["__scopeId","data-v-e24f3c5d"]]);export{Ot as default};
